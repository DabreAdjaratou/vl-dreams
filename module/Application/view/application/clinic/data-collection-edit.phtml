<?php
if(trim($countryId)!= ''){
    $link = "/clinic/data-collection/".base64_encode($countryId);
}else{
    $link = "/clinic/data-collection";
}
?>
<link rel="stylesheet" type="text/css" href="<?php echo $this->basePath() .'/assets/css/jquery-ui.css' ?>"/>
<style>
    .ui-datepicker-calendar {
       display: none;
    }
    .ui-datepicker-month,.ui-datepicker-year{
       display:block;
       display:inline-block;
    }
    #ancFormTable thead tr th{
        text-align:center;
    }
</style>
<div id="page-content">
    <div class="row section-header">
        <div class="col m6 s12 left-align" style="font-size: 34px;font-weight:400;">Edit ANC Monthly Reporting</div>
        <div class="col m6 s12 classic-breadcrumbs right-align">
            <a href="<?php echo $this->url('home'); ?>" class="breadcrumb">Home</a>
            <a href="<?php echo $link; ?>" class="breadcrumb">ANC Monthly Reporting</a>
            <a href="javascript:void(0);" class="breadcrumb" style="cursor:default;">Edit ANC Monthly Reporting</a>
       </div>
    </div>
    <div class="row dashboard-wrapper content-container">
        <form id="editClinicDataReportingForm" name="editClinicDataReportingForm" method="post" action="<?php echo $this->url('clinic-data-collection-edit'); ?>">
            <div class="col l12 m12 s12" style="pointer-events:<?php echo ($row->status == 2)?'none':'auto'; ?>;">
                <div class="col l6 m6 s6" style="text-align:center;"><strong>Anc Site *</strong> <select class="material-select isRequired" id="anc" name="anc" title="Please select anc site" onchange="checkDublicateDataReporting();"><option value=""> -- Select -- </option><?php foreach($ancSites as $anc) { ?><option value="<?php echo base64_encode($anc['anc_site_id']); ?>" <?php echo($row->anc == $anc['anc_site_id'])?'selected="selected"':''; ?>><?php echo ucwords($anc['anc_site_name']); ?></option><?php } ?></select></div>
                <div class="col l6 m6 s6" style="text-align:center;"><strong>Month/Year *</strong> <input type="text" class="isRequired" id="reportingMonthYear" name="reportingMonthYear" placeholder="Select Month and Year" title="Please select month and year" value="<?php echo ucfirst($row->reporting_month_year); ?>" readonly/></div>
            </div>
            <div class="col l12 m12 s12">
                <div class="card card-default table-height">
                    <div class="card-content clearfix">
                        <table id="ancFormTable" class="responsive-table display">
                            <thead>
                                <tr>
                                    <th>Characteristics</th>
                                    <th>Age < 15</th>
                                    <th>Age 15-19</th>
                                    <th>Age 20-24</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php
                                //set characteristics array data from josn data
                                if(isset($row->characteristics_data) && trim($row->characteristics_data)!= ''){
                                  $fieldArray = array();
                                  $fields = json_decode($row->characteristics_data,true);
                                  foreach($fields as $fieldName=>$fieldValue){
                                    foreach($fieldValue[0] as $characteristicsName=>$characteristicsValue){
                                        $fieldArray[$fieldName][$characteristicsName] = $characteristicsValue;
                                    }
                                  }
                                }
                                $r=1;
                                foreach($ancFormFields as $key=>$value){
                                    $fieldName = $key;
                                    $formLabel = ucwords(str_replace("_"," ",$key));
                                    $formLabel = str_replace("No","No.",$formLabel);
                                    //set readonly fields based on age disaggregation
                                    $commonFieldsStyle = ($row->status == 2)?'pointer-events:none;':'pointer-events:auto;';
                                    $styleTotal = 'pointer-events:none;';
				    $commonFieldsIsRequired = 'isRequired';
				    $isRequiredTotal = '';
                                    if($value == 'no'){
                                        $commonFieldsStyle = 'pointer-events:none;';
					//enable/disable No. Of Clients Who Received Recency Result fields based on status
                                        $styleTotal = ($row->status == 2 && $fieldName!= 'no_of_clients_who_received_recency_result')?'pointer-events:none;':'pointer-events:auto;';
					$commonFieldsIsRequired = '';
					$isRequiredTotal = 'isRequired';
                                    }
                                    //set characteristics value
				    $ageLt15 = '';
				    $age15To19 ='';
				    $age20to24 = '';
				    $total = '';
                                    if(array_key_exists($key,$fieldArray)){
                                        $ageLt15 = (isset($fieldArray[$key]['age_lt_15']) && $fieldArray[$key]['age_lt_15']!= '')?$fieldArray[$key]['age_lt_15']:'';
                                        $age15To19 = (isset($fieldArray[$key]['age_15_to_19']) && $fieldArray[$key]['age_15_to_19']!= '')?$fieldArray[$key]['age_15_to_19']:'';
                                        $age20to24 = (isset($fieldArray[$key]['age_20_to_24']) && $fieldArray[$key]['age_20_to_24']!= '')?$fieldArray[$key]['age_20_to_24']:'';
                                        $total = (isset($fieldArray[$key]['total']) && $fieldArray[$key]['total']!= '')?$fieldArray[$key]['total']:'';
                                    }
                                ?>
                                    <tr>
                                      <td style="<?php echo($r > 1)?'padding-top:0px;padding-bottom:0px;':'padding-bottom:0px;'; ?>"><input type="hidden" id="field<?php echo $r; ?>" name="field[]" value="<?php echo $fieldName; ?>" style="height:2rem;"/><?php echo $formLabel; ?> *</td>
                                      <td style="<?php echo($r > 1)?'padding-top:0px;padding-bottom:0px;':'padding-bottom:0px;'; ?>"><input id="<?php echo $fieldName; ?>_age_lt_15" name="<?php echo $fieldName; ?>[age_lt_15]" type="text" class="checkNum <?php echo $fieldName.' '.$commonFieldsIsRequired; ?>" title="Please fill in all the required fields" value="<?php echo $ageLt15; ?>" onkeyup="getTotal('<?php echo $fieldName; ?>');" style="height:2rem;<?php echo $commonFieldsStyle; ?>"/></td>
                                      <td style="<?php echo($r > 1)?'padding-top:0px;padding-bottom:0px;':'padding-bottom:0px;'; ?>"><input id="<?php echo $fieldName; ?>_age_15_to_19" name="<?php echo $fieldName; ?>[age_15_to_19]" type="text" class="checkNum <?php echo $fieldName.' '.$commonFieldsIsRequired; ?>" title="Please fill in all the required fields" value="<?php echo $age15To19; ?>" onkeyup="getTotal('<?php echo $fieldName; ?>');" style="height:2rem;<?php echo $commonFieldsStyle; ?>"/></td>
                                      <td style="<?php echo($r > 1)?'padding-top:0px;padding-bottom:0px;':'padding-bottom:0px;'; ?>"><input id="<?php echo $fieldName; ?>_age_20_to_24" name="<?php echo $fieldName; ?>[age_20_to_24]" type="text" class="checkNum <?php echo $fieldName.' '.$commonFieldsIsRequired; ?>" title="Please fill in all the required fields" value="<?php echo $age20to24; ?>" onkeyup="getTotal('<?php echo $fieldName; ?>');" style="height:2rem;<?php echo $commonFieldsStyle; ?>"/></td>
                                      <td style="<?php echo($r > 1)?'padding-top:0px;padding-bottom:0px;':'padding-bottom:0px;'; ?>"><input id="<?php echo $fieldName; ?>_total" name="<?php echo $fieldName; ?>[total]" type="text" class="checkNum <?php echo $isRequiredTotal; ?>" title="Please fill in all the required fields" value="<?php echo $total; ?>" style="height:2rem;<?php echo $styleTotal; ?>"/></td>
                                    </tr>
                                <?php $r++; } ?>
				<tr>
				    <td style="padding-top:0px;padding-bottom:0px;">Comments</td>
				    <td colspan="4" style="padding-top:0px;padding-bottom:0px;">
					<textarea id="comments" name="comments" class="materialize-textarea" style="height:2rem;pointer-events:<?php echo ($row->status == 2)?'none':'auto'; ?>;"><?php echo $row->comments; ?></textarea>
				    </td>
				</tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col s12" style="margin-top:20px;">
                <input type="hidden" name="clinicDataCollectionId" id="clinicDataCollectionId" value="<?php echo base64_encode($row->cl_data_collection_id); ?>"/>
		<input type="hidden" name="chosenCountry" id="chosenCountry" value="<?php echo base64_encode($countryId); ?>"/>
		<input type="hidden" name="status" id="status" value="<?php echo base64_encode($row->status); ?>"/>
		<input type="hidden" name="redirectUrl" id="redirectUrl" value="<?php echo $link;?>"/>
                <a href="<?php echo $link;?>" class="waves-effect waves-light btn-small btn pink-text custom-btn custom-btn-pink margin-bottom-10">Cancel</a>
                <a href="javascript:void(0);" class="waves-effect waves-light btn-small white-text pink margin-bottom-10" onclick="updateDataReporting();">UPDATE</a>&nbsp;&nbsp;
            </div>
        </form>
    </div>
</div>
<script type="text/javascript" src="<?php echo $this->basePath() .'/assets/js/jquery-ui.js' ?>"></script>
<script>
    $(document).ready(function(){
       $('#reportingMonthYear').datepicker({
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true,
            dateFormat: 'M/yy',
            maxDate: 'Today',
            beforeShow : function(input, inst) {
                tmp = $('#reportingMonthYear').val().split('/');
                var dat = new Date('1 ' + tmp[0] + ' 1969');
                $('#reportingMonthYear').datepicker('option','defaultDate',new Date(tmp[1],parseInt(dat.getMonth()-1)+parseInt(1),1));
                $('#reportingMonthYear').datepicker('setDate', new Date(tmp[1], parseInt(dat.getMonth()-1)+parseInt(1), 1));
            },
            onClose: function(dateText, inst) {
                var month=$("#ui-datepicker-div .ui-datepicker-month :selected").val();
                var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                $('#reportingMonthYear').datepicker('setDate', new Date(year, month, 1));
		checkDublicateDataReporting();
            },
	    onChangeMonthYear: function(e){
                checkDublicateDataReporting();
            }
       });
    });
    
    function getTotal(commonFieldClassName){
        var total = 0;
        $('.'+commonFieldClassName).each( function(i,e) {
           /* you can use e.id instead of $(e).attr('id') */
            if($('#'+$(e).attr('id')).val()!= ''){
                total = parseInt(total)+parseInt($('#'+$(e).attr('id')).val());
                $('#'+commonFieldClassName+'_total').val(total);
            }
        });
    }
    
    function checkDublicateDataReporting(){
        var reportingMonthYear = $('#reportingMonthYear').val();
        var anc = $('#anc').val();
        if($.trim(reportingMonthYear)!= '' && $.trim(anc)!= ''){
            $.post("<?php echo $this->url('check-duplicate-data-report'); ?>", {clDataCollectionID:'<?php echo base64_encode($row->cl_data_collection_id); ?>',reportingMonthYear: reportingMonthYear,anc:anc},
            function(data) {
                if($.trim(data) == 1){
                    alert('Duplicate data not allowed. The monthly data for anc site and year/month that you have choosed already entered');
                    $('#reportingMonthYear').val('');
                }
            });
        }
    }
    
    function updateDataReporting(){
        flag = deforayValidator.init({
            formId: 'editClinicDataReportingForm'
        });
        
        if(flag){
            document.getElementById('editClinicDataReportingForm').submit();
        }
    }
</script>