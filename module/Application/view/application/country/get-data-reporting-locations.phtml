<?php
$location = 0;
if(isset($response['ancs']) && count($response['ancs']) > 0){
    foreach($response['ancs'] as $anc){
        if(trim($anc['latitude'])!= '' && trim($anc['longitude'])!= ''){
           $location+= 1;
        }
    }
}else{
    if(isset($response['labRecent']) && count($response['labRecent']) > 0){
        foreach($response['labRecent'] as $labRecentPoint){
            if(trim($labRecentPoint['latitude'])!= '' && trim($labRecentPoint['longitude'])!= ''){
                $location+= 1;
            }
        }
    } if(isset($response['ancRecent']) && count($response['ancRecent']) > 0){
        foreach($response['ancRecent'] as $ancRecentPoint){
            if(trim($ancRecentPoint['latitude'])!= '' && trim($ancRecentPoint['longitude'])!= ''){
                $location+= 1;
            }
        }
    }
}
$sitehavingRecentInfectionbyArray = array();
if(trim($params['sitehavingRecentInfectionby'])!= ''){
    $sitehavingRecentInfectionbyArray = explode(",",$params['sitehavingRecentInfectionby']);
}
if($location > 0) { ?>
    <div class="gmap" id="gmap" style="min-height: 500px;width:100%;"></div>
    <script>
        $(document).ready(function(){
            var map;
            var bounds = new google.maps.LatLngBounds();
            var mapOptions = {
                mapTypeId: 'roadmap',
                scrollwheel: false
            };  
           // Display a map on the page
           map = new google.maps.Map(document.getElementById("gmap"),mapOptions);
            // Multiple Markers
            var markers = [
                //ancs
                <?php
                if(isset($response['ancs']) && count($response['ancs']) > 0){
                    foreach($response['ancs'] as $anc){
                        if(trim($anc['latitude'])!= '' && trim($anc['longitude'])!= ''){
                ?>
                {
                 lat: "<?php echo $anc['latitude']; ?>",
                 lon: "<?php echo $anc['longitude']; ?>",
                 icon : "anc-red",
                 label : "<h6><?php echo ucwords($anc['anc_site_name']);?></h6>"
                },
                <?php } } } ?>
                //lab recent points
                <?php
                if(isset($response['labRecent']) && count($response['labRecent']) > 0){
                    foreach($response['labRecent'] as $labRecentPoint){
                        if(trim($labRecentPoint['latitude'])!= '' && trim($labRecentPoint['longitude'])!= ''){
                            $colorArray = array();
                            if(in_array('labLAgRecency',$sitehavingRecentInfectionbyArray) && trim($labRecentPoint['lag_avidity_result']) == 'recent'){
                                $colorArray[] = 'anc-blue';
                            } if(in_array('labAsanteRecency',$sitehavingRecentInfectionbyArray) && $labRecentPoint['asante_rapid_recency_assy']!= null && trim($labRecentPoint['asante_rapid_recency_assy'])!= ''){
                                $labAsanteRecencyArray = json_decode($labRecentPoint['asante_rapid_recency_assy'],true);
                                if(isset($labAsanteRecencyArray['rrr']['assay']) && trim($labAsanteRecencyArray['rrr']['assay']) == 'absent'){
                                   $colorArray[] = 'anc-green';
                                }
                            }
                ?>
                {
                 lat: "<?php echo $labRecentPoint['latitude']; ?>",
                 lon: "<?php echo $labRecentPoint['longitude']; ?>",
                 icon : "<?php echo implode(',',$colorArray); ?>",
                 label : "<h6><?php echo ucwords($labRecentPoint['anc_site_name']);?></h6>"
                },
                <?php } } } ?>
                //anc recent sites
                <?php
                if(isset($response['ancRecent']) && count($response['ancRecent']) > 0){
                    foreach($response['ancRecent'] as $ancRecentPoint){
                        if(trim($ancRecentPoint['latitude'])!= '' && trim($ancRecentPoint['longitude'])!= ''){
                            $colorArray = array();
                            if(isset($ancRecentPoint['recency_line'])&& $ancRecentPoint['recency_line']!= null && trim($ancRecentPoint['recency_line']) == 'recent' && in_array('ancRapidRecency',$sitehavingRecentInfectionbyArray)){
                                $colorArray[] = 'anc-purple';
                            }
                ?>
                {
                 lat: "<?php echo $ancRecentPoint['latitude']; ?>",
                 lon: "<?php echo $ancRecentPoint['longitude']; ?>",
                 icon: "<?php echo implode(',',$colorArray); ?>",
                 label: "<h6><?php echo ucwords($ancRecentPoint['anc_site_name']);?></h6>"
                },
                <?php } } } ?>
            ];
            
            // Loop through our array of markers & place each one on the map
            for( i = 0; i < markers.length; i++ ) {
                var position = new google.maps.LatLng(markers[i]['lat'], markers[i]['lon']);
                bounds.extend(position);
                var iconArray = markers[i]['icon'].split(",");
                for( j = 0; j < iconArray.length; j++ ) {
                    if(iconArray[j] == 'anc-red'){
                        var iconImg = '<?php echo $this->basePath('assets/images/map-points/red.png'); ?>';
                    }else if(iconArray[j] == 'anc-blue'){
                        var iconImg = '<?php echo $this->basePath('assets/images/map-points/blue.png'); ?>';
                    }else if(iconArray[j] == 'anc-green'){
                        var iconImg = '<?php echo $this->basePath('assets/images/map-points/green.png'); ?>';
                    }else if(iconArray[j] == 'anc-purple'){
                        var iconImg = '<?php echo $this->basePath('assets/images/map-points/purple.png'); ?>';
                    }
                    marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        icon : iconImg
                    });
                    marker['infowindow'] = new google.maps.InfoWindow({
                        content: markers[i]['label']    
                    });
                    google.maps.event.addListener(marker, 'mouseover', function() {
                        current_infowindow = this['infowindow'];
                        current_infowindow.open(map, this);
                    });
                    google.maps.event.addListener(marker, 'mouseout', function () {
                        current_infowindow.close();
                    });
                }
                // Automatically center the map fitting all markers on the screen
                map.fitBounds(bounds);
            }
            // Override our map zoom level once our fitBounds function runs (Make sure it only runs once)
            var boundsListener = google.maps.event.addListener((map), 'bounds_changed', function(event) {
                this.setZoom(8);
                google.maps.event.removeListener(boundsListener);
            });
         });
    </script>
<?php } else { ?>
    <div style="text-align:center;"><h6>Location not available..</h6></div>
<?php } ?>