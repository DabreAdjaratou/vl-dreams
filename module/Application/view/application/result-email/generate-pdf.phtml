<?php
use Zend\Session\Container;
$alertContainer = new Container('alert');
$common = new \Application\Service\CommonService();
$alertContainer->aliasPage = 1;
$alertContainer->nbPages = count($dataResult);
    class MYPDF extends TCPDF {
	public function setSchemeName($heading,$logo) {
	    $this->heading = $heading;
	    $this->logo = $logo;
	}
	
	public function Header() {
	    // Logo
            $image_file = APPLICATION_PATH . DIRECTORY_SEPARATOR . 'assets'. DIRECTORY_SEPARATOR . 'images'. DIRECTORY_SEPARATOR . $this->logo;
            $this->Image($image_file, 12,3, 20, '', 'PNG', '', 'T', false, 300, '', false, false, 0, false, false, false);
             //Set font
            $this->SetFont('helvetica', 'B', 20);
             //Title
            $this->writeHTMLCell(0,'',36,10,$this->heading,0,1,false,true,'C',true);
	    $this->writeHTMLCell(0,'','','','<br/><hr/>',0,1,false,true,'C',true);
	}
	
	// Page footer
	public function Footer() {
	    $alertContainer = new Container('alert');
	    // Position at 15 mm from bottom
	    $this->SetY(-15);
	    // Set font
	    $this->SetFont('helvetica', 'I', 8);
	    // Page number
	    $this->Cell(0, 10, 'Page '.$alertContainer->aliasPage.'/'.$alertContainer->nbPages, 0, false, 'C', 0, '', 0, false, 'T', 'M');
	}
    }
    
    class Pdf_concat extends FPDI {
	var $files = array();
     
	function setFiles($files) {
	    $this->files = $files;
	}
     
	function concat() {
	    foreach($this->files AS $file) {
		 $pagecount = $this->setSourceFile($file);
		 for ($i = 1; $i <= $pagecount; $i++) {
		      $tplidx = $this->ImportPage($i);
		      $s = $this->getTemplatesize($tplidx);
		      $this->AddPage('P', array($s['w'], $s['h']));
		      $this->useTemplate($tplidx);
		 }
	    }
	}
    }

    //$pdf->SetY(20,true,false);
    $page = 1;
    $pages = array();
    foreach($dataResult as $data){
	$alertContainer->aliasPage = $page;
	// create new PDF document
	$pdf = new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $pdf->setSchemeName('Lab Data Reporting Result','dreams-small-logo.png');
        // set document information
        $pdf->SetCreator(PDF_CREATOR);
        $pdf->SetAuthor('Dream');
        $pdf->SetTitle('Lab Data Reporting Result');
        //$pdf->SetSubject('TCPDF Tutorial');
        //$pdf->SetKeywords('TCPDF, PDF, example, test, guide');
        
        // set default header data
        $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);
        
        // set header and footer fonts
        $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
        
        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
        
        // set margins
        //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_RIGHT);
        //$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        //$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
        
        // set auto page breaks
        $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
        
        // set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
        
	// set font
	$pdf->SetFont('helvetica', '', 10);
	
	$pdf->AddPage();
	$pdf->SetY(30,true,false);
	
	$specimenCollectedDate = '';
	if(isset($data['specimen_collected_date']) && trim($data['specimen_collected_date'])!= '' && $data['specimen_collected_date']!= '0000-00-00'){
	    $specimenCollectedDate = $common->humanDateFormat($data['specimen_collected_date']);
	}
	$specimenPickedUpDateAtAnc = '';
	if(isset($data['specimen_picked_up_date_at_anc']) && trim($data['specimen_picked_up_date_at_anc'])!= '' && $data['specimen_picked_up_date_at_anc']!= '0000-00-00'){
	    $specimenPickedUpDateAtAnc = $common->humanDateFormat($data['specimen_picked_up_date_at_anc']);
	}
	$patientDOB = '';
	if(isset($data['patient_dob']) && trim($data['patient_dob'])!= '' && $data['patient_dob']!= '0000-00-00'){
	    $patientDOB = $common->viewDateFormat($data['patient_dob']);
	}
	$rejectionCode = (isset($data['rejection_code']))?$data['rejection_code']:'';
	$receiptDateAtCentralLab = '';
	if(isset($data['receipt_date_at_central_lab']) && trim($data['receipt_date_at_central_lab'])!= '' && $data['receipt_date_at_central_lab']!= '0000-00-00'){
	    $receiptDateAtCentralLab = $common->humanDateFormat($data['receipt_date_at_central_lab']);
	}
	$testCompletionDate = '';
	if(isset($data['date_of_test_completion']) && trim($data['date_of_test_completion'])!= '' && $data['date_of_test_completion']!= '0000-00-00'){
	    $testCompletionDate = $common->humanDateFormat($data['date_of_test_completion']);
	}
	$resultDispatchedDateToClinic = '';
	if(isset($data['result_dispatched_date_to_clinic']) && trim($data['result_dispatched_date_to_clinic'])!= '' && $data['result_dispatched_date_to_clinic']!= '0000-00-00'){
	    $resultDispatchedDateToClinic = $common->humanDateFormat($data['result_dispatched_date_to_clinic']);
	}
	$specimenType ='';
	if($data['specimen_type'] == 1){
          $specimenType = 'Venous';
        }else if($data['specimen_type'] == 2){
          $specimenType = 'Plasma';
        }else if($data['specimen_type'] == 3){
           $specimenType = 'DBS';
        }
	$lAgAvidityResult = '';
	if(trim($data['lag_avidity_result'])!= '' && $data['lag_avidity_result'] =='lt'){
	    $lAgAvidityResult = 'Long Term';
	}else if(trim($data['lag_avidity_result'])!= '' && $data['lag_avidity_result'] =='r'){
	    $lAgAvidityResult = 'Recent';
	}
	$hIVRNAResult = '';
	if(trim($data['hiv_rna_gt_1000'])!= '' && $data['hiv_rna_gt_1000'] =='yes'){
	    $hIVRNAResult = 'High Viral Load';
	}else if(trim($data['hiv_rna_gt_1000'])!= '' && $data['hiv_rna_gt_1000'] =='no'){
	    $hIVRNAResult = 'Low Viral Load';
	}
	$statusName = (isset($data['test_status_name']))?ucwords($data['test_status_name']):'';
	//pdf content
	$html = '';
	$html .= '<table style="padding:2px;">';
	$html .='<tr><td colspan="6" style="text-align:left;"><h5>SURVEILLANCE INFORMATION</h5></td></tr>';
	$html .='<tr>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Study ID</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['study_id'].'</td>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Date Specimen Collected</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$specimenCollectedDate.'</td>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>ANC Site Code/Name</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['anc_site_code'].' - '.ucwords($data['anc_site_name']).'</td>';
	$html.='</tr>';
	$html .='<tr>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Date Specimen Picked Up at ANC</strong></td><td colspan="5" style="line-height:18px;font-size:10px;text-align:left;">'.$specimenPickedUpDateAtAnc.'</td>';
	$html .='</tr>';
	$html .='<tr><td colspan="6" style="height:10px;"></td></tr>';
	$html .='<tr><td colspan="6" style="text-align:left;"><h5>PATIENT INFORMATION</h5></td></tr>';
	$html .='<tr>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>ANC Patient ID</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['anc_patient_id'].'</td>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>ART Number</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['art_patient_id'].'</td>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Encrypted Patient ID</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['enc_anc_patient_id'].'</td>';
	$html .='</tr>';
	$html .='<tr>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>DOB</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$patientDOB.'</td>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Age</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['age'].'</td>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Gestation Age (Weeks)</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['gestational_age'].'</td>';
	$html .='</tr>';
	$html .='<tr><td colspan="6" style="height:10px;"></td></tr>';
	$html .='<tr><td colspan="6" style="text-align:left;"><h5>LABORATORY INFORMATION</h5></td></tr>';
	$html .='<tr>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Lab Site Code/Name</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['facility_code'].' - '.ucwords($data['facility_name']).'</td>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Lab Specimen ID</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['lab_specimen_id'].'</td>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Speciemen Rejection Code</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$rejectionCode.'</td>';
	$html .='</tr>';
	$html .='<tr>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Date Of Receipt at Central Lab</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$receiptDateAtCentralLab.'</td>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Date Of Test Completion</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$testCompletionDate.'</td>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Date Of Result Dispatched To Clinic</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$resultDispatchedDateToClinic.'</td>';
	$html .='</tr>';
	$html .='<tr>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Specimen Type</strong></td><td colspan="5" style="line-height:18px;font-size:10px;text-align:left;">'.$specimenType.'</td>';
	$html .='</tr>';
	$html .='<tr><td colspan="6" style="height:10px;"></td></tr>';
	$html .='<tr><td colspan="6" style="text-align:left;"><h5>TEST RESULT</h5></td></tr>';
	$html .='<tr>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>LAg Avidity ODn</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$data['final_lag_avidity_odn'].'</td>';
	    $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>HIV RNA(copies/ml)</strong></td><td colspan="3" style="line-height:18px;font-size:10px;text-align:left;">'.$data['hiv_rna'].'</td>';
	$html .='</tr>';
	$html .='<tr>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>LAg Avidity Result</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.$lAgAvidityResult.'</td>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>HIV RNA > 1000 (copies/ml)</strong> </td><td style="line-height:18px;font-size:10px;text-align:left;">'.$hIVRNAResult.'</td>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Recent Infection(LAg-R & RNA > 1000)</strong></td><td style="line-height:18px;font-size:10px;text-align:left;">'.ucfirst($data['recent_infection']).'</td>';
	$html .='</tr>';
	$html .='<tr>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Status</strong></td><td colspan="5" style="line-height:18px;font-size:10px;text-align:left;">'.$statusName.'</td>';
	$html .='</tr>';
	$html .='<tr><td colspan="6" style="height:10px;"></td></tr>';
	$html .='<tr>';
	   $html .='<td style="line-height:18px;font-size:10px;text-align:left;"><strong>Comments</strong></td><td colspan="5" style="line-height:18px;font-size:10px;text-align:left;">'.ucfirst($data['comments']).'</td>';
	$html .='</tr>';
	$html .='</table>';
	$pdf->writeHTML($html);
	$pdf->lastPage();
	$filename = TEMP_UPLOAD_PATH. DIRECTORY_SEPARATOR .'p'.$page. '.pdf';
	$pdf->Output($filename,"F");
	$pages[] = $filename;
       $page++;
    }
    $resultFilename = '';
    if(count($pages) >0){
	$resultPdf = new Pdf_concat();
	$resultPdf->setFiles($pages);
	$resultPdf->setPrintHeader(false);
        $resultPdf->setPrintFooter(false);
	$resultPdf->concat();
	$resultFilename = 'Lab-Data-Reporting-Result-'.date('d-M-Y-H-i-s').'.pdf';
	$resultPdf->Output(TEMP_UPLOAD_PATH. DIRECTORY_SEPARATOR .$resultFilename, "F");
	echo $resultFilename;
    }