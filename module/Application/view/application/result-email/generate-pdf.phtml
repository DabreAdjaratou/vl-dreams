<?php
use Zend\Session\Container;
$alertContainer = new Container('alert');
$common = new \Application\Service\CommonService();
$alertContainer->aliasPage = 1;
$alertContainer->nbPages = count($dataResult);
    class MYPDF extends TCPDF {
	public function setSchemeName($heading,$logo) {
	    $this->heading = $heading;
	    $this->logo = $logo;
	}
	
	public function Header() {
	    // Logo
            $image_file = APPLICATION_PATH . DIRECTORY_SEPARATOR . 'assets'. DIRECTORY_SEPARATOR . 'images'. DIRECTORY_SEPARATOR . $this->logo;
            $this->Image($image_file, 12,3, 20, '', 'PNG', '', 'T', false, 300, '', false, false, 0, false, false, false);
             //Set font
            $this->SetFont('helvetica', 'B', 20);
             //Title
            $this->writeHTMLCell(0,'',36,10,$this->heading,0,1,false,true,'C',true);
	    $this->writeHTMLCell(0,'','','','<br/>',0,1,false,true,'C',true);
	}
	
	// Page footer
	public function Footer() {
	    $alertContainer = new Container('alert');
	    // Position at 15 mm from bottom
	    $this->SetY(-15);
	    // Set font
	    $this->SetFont('helvetica', 'I', 8);
	    // Page number
	    $this->Cell(0, 10, 'Page '.$alertContainer->aliasPage.'/'.$alertContainer->nbPages, 0, false, 'C', 0, '', 0, false, 'T', 'M');
	}
    }
    
    class Pdf_concat extends FPDI {
	var $files = array();
     
	function setFiles($files) {
	    $this->files = $files;
	}
     
	function concat() {
	    foreach($this->files AS $file) {
		 $pagecount = $this->setSourceFile($file);
		 for ($i = 1; $i <= $pagecount; $i++) {
		      $tplidx = $this->ImportPage($i);
		      $s = $this->getTemplatesize($tplidx);
		      $this->AddPage('P', array($s['w'], $s['h']));
		      $this->useTemplate($tplidx);
		 }
	    }
	}
    }

    //$pdf->SetY(20,true,false);
    $page = 1;
    $pages = array();
    foreach($dataResult as $data){
	$alertContainer->aliasPage = $page;
	// create new PDF document
	$pdf = new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $pdf->setSchemeName('Laboratory Recency Test Result','dreams-small-logo.png');
        // set document information
        $pdf->SetCreator(PDF_CREATOR);
        $pdf->SetAuthor('Dream');
        $pdf->SetTitle('Laboratory Recency Test Result');
        //$pdf->SetSubject('TCPDF Tutorial');
        //$pdf->SetKeywords('TCPDF, PDF, example, test, guide');
        
        // set default header data
        $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);
        
        // set header and footer fonts
        $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
        
        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
        
        // set margins
        //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_RIGHT);
        //$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        //$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
        
        // set auto page breaks
        $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
        
        // set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
        
	// set font
	$pdf->SetFont('helvetica', '', 10);
	
	$pdf->AddPage();
	$pdf->SetY(30,true,false);
	
	$patientDOB = '';
	if(isset($data['patient_dob']) && $data['patient_dob']!= null && trim($data['patient_dob'])!= '' && $data['patient_dob']!= '0000-00-00'){
	    $patientDOB = $common->viewDateFormat($data['patient_dob']);
	}
	$specimenCollectedDate = '';
	if(isset($data['specimen_collected_date']) && $data['specimen_collected_date']!= null && trim($data['specimen_collected_date'])!= '' && $data['specimen_collected_date']!= '0000-00-00'){
	    $specimenCollectedDate = $common->humanDateFormat($data['specimen_collected_date']);
	}
	$specimenPickedUpDateAtAnc = '';
	if(isset($data['specimen_picked_up_date_at_anc']) && $data['specimen_picked_up_date_at_anc']!= null && trim($data['specimen_picked_up_date_at_anc'])!= '' && $data['specimen_picked_up_date_at_anc']!= '0000-00-00'){
	    $specimenPickedUpDateAtAnc = $common->humanDateFormat($data['specimen_picked_up_date_at_anc']);
	}
	$receiptDateAtCentralLab = '';
	if(isset($data['receipt_date_at_central_lab']) && $data['receipt_date_at_central_lab']!= null && trim($data['receipt_date_at_central_lab'])!= '' && $data['receipt_date_at_central_lab']!= '0000-00-00'){
	    $receiptDateAtCentralLab = $common->humanDateFormat($data['receipt_date_at_central_lab']);
	}
	$testCompletionDate = '';
	if(isset($data['date_of_test_completion']) && $data['date_of_test_completion']!= null && trim($data['date_of_test_completion'])!= '' && $data['date_of_test_completion']!= '0000-00-00'){
	    $testCompletionDate = $common->humanDateFormat($data['date_of_test_completion']);
	}
	$rejectionCode = (isset($data['rejection_code']))?$data['rejection_code']:'';
	$resultDispatchedDateToClinic = '';
	if(isset($data['result_dispatched_date_to_clinic']) && $data['result_dispatched_date_to_clinic']!= null && trim($data['result_dispatched_date_to_clinic'])!= '' && $data['result_dispatched_date_to_clinic']!= '0000-00-00'){
	    $resultDispatchedDateToClinic = $common->humanDateFormat($data['result_dispatched_date_to_clinic']);
	}
	$resultImage = '';
	if(isset($data['lag_avidity_result']) && trim($data['lag_avidity_result']) == 'r'){
	    $resultImage = '<img src="'.$this->basePath() .'/assets/images/recent.png" alt="Recent">';
	}else if(isset($data['lag_avidity_result']) && trim($data['lag_avidity_result']) == 'lt'){
	    $resultImage = '<img src="'.$this->basePath() .'/assets/images/long-term.png" alt="Long Term">';
	}
	//pdf content
	$html = '';
	$html .= '<table style="padding:2px;border:1px solid #f1f8fb;">';
	    //facility info
	    $html .='<tr><td colspan="2" style="line-height:30px;text-align:left;font-size:16px;border:1px solid #f1f8fb;">Facility Information</td></tr>';
	    $html .='<tr><td style="width:30%;line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>ANC Site Name:</strong></td><td style="width:70%;line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.ucwords($data['anc_site_name']).'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>ANC Site Code:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$data['anc_site_code'].'</td></tr>';
	    //patient info
	    $html .='<tr><td colspan="2" style="line-height:30px;text-align:left;font-size:16px;border:1px solid #f1f8fb;">Patient Information</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>ANC Patient ID:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$data['anc_patient_id'].'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>ART Number:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$data['art_patient_id'].'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Age DOB/ Age:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$patientDOB.' / <strong>'.$data['age'].'</strong></td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>ART Patient If (if any):</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$data['art_patient_id'].'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Gestation Age in (Weeks):</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$data['gestational_age'].'</td></tr>';
	    //laboratory info
	    $html .='<tr><td colspan="2" style="line-height:30px;text-align:left;font-size:16px;border:1px solid #f1f8fb;">Laboratory Information</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Sample Collection Date:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$specimenCollectedDate.'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Sample Pickup Date:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$specimenPickedUpDateAtAnc.'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Sample Received at Recency/VL Lab:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$receiptDateAtCentralLab.'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Date of Test Completion:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$testCompletionDate.'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Specimen Rejection Code:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$rejectionCode.'</td></tr>';
	    $html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Result Dispatch Date:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;">'.$resultDispatchedDateToClinic.'</td></tr>';
	    if($data['rejection_reason'] == null || trim($data['rejection_reason']) == '' || $data['rejection_reason'] == 0){
		//test result info
		$html .='<tr><td colspan="2" style="line-height:30px;text-align:left;font-size:16px;">Test Result</td></tr>';
		$html .='<tr><td colspan="2">'.$resultImage.'</td></tr>';
		//recency test result - lt/r info
		//$html .='<tr><td colspan="2" style="line-height:30px;text-align:left;font-size:16px;border:1px solid #f1f8fb;">Recency Test Result - Long Term / Recent</td></tr>';
		//$html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>Additional Information:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"></td></tr>';
		//$html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>LAg OD Value:</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"></td></tr>';
		//$html .='<tr><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"><strong>VL(cp/ml):</strong></td><td style="line-height:18px;font-size:10px;text-align:left;border:1px solid #f1f8fb;"></td></tr>';
	    }
	$html .='</table>';
	$pdf->writeHTML($html);
	$pdf->lastPage();
	$filename = TEMP_UPLOAD_PATH. DIRECTORY_SEPARATOR .'p'.$page. '.pdf';
	$pdf->Output($filename,"F");
	$pages[] = $filename;
       $page++;
    }
    $resultFilename = '';
    if(count($pages) >0){
	$resultPdf = new Pdf_concat();
	$resultPdf->setFiles($pages);
	$resultPdf->setPrintHeader(false);
        $resultPdf->setPrintFooter(false);
	$resultPdf->concat();
	$resultFilename = 'Laboratory-Recency-Test-Result-'.date('d-M-Y-H-i-s').'.pdf';
	$resultPdf->Output(TEMP_UPLOAD_PATH. DIRECTORY_SEPARATOR .$resultFilename, "F");
	echo $resultFilename;
    }